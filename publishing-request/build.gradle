plugins {
    id 'org.unbroken-dome.test-sets' version '4.0.0'
}
testSets {
    integrationTest
    karateTest {
        extendsFrom  integrationTest
        dirName = 'karate'
        systemProperty "karate.options", System.properties.getProperty("karate.options")
        systemProperty "karate.env", System.properties.getProperty("karate.env")
    }
}

task karateExecute(type: JavaExec) {
    classpath = sourceSets.test.runtimeClasspath
    main = "com.intuit.karate.cli.Main"
}

//tasks.named('karateTest') {
//    useJUnitPlatform {
//        includeTags 'KarateTest'
//    }
//}


dependencies {
    implementation project(":storage-model")
    implementation project(":publication-commons")

    implementation libs.nva.apigateway
    implementation libs.nva.identifiers
    implementation libs.nva.core
    implementation libs.nva.json
    implementation(libs.nva.datamodel.core) {
        exclude group: 'com.github.bibsysdev', module: 'nva-commons'
    }
    implementation libs.aws.sdk.dynamodb

    implementation libs.jackson.annotations
    implementation libs.jackson.databind

    implementation libs.guava
    implementation libs.zalando
    implementation libs.bundles.logging

    runtimeOnly libs.jackson.core

    testImplementation libs.nva.datamodel.testutils
    testImplementation libs.jackson.core
    testImplementation project(':publication-testing')
    testImplementation libs.nva.testutils
    testImplementation(libs.javafaker) {
        because('For generating test data in tests. Another alternative is jfairy')
    }

    compileOnly libs.zalando
    compileOnly libs.aws.lambda.java.core

    testImplementation libs.karate.core
    testImplementation libs.karate.junit5

    integrationTestImplementation libs.karate.core
    integrationTestImplementation libs.karate.junit5

}

test {
    useJUnitPlatform {
        excludeTags 'KarateTest'
    }
    environment "AWS_REGION", "eu-west-1"
    environment "COGNITO_HOST", "https://example.com"
    environment "ALLOWED_ORIGIN", "*"
}

//task karateTest {
//    useJUnitPlatform {
//        includeTags('KarateTest')
//    }
//
//    systemProperty "karate.options", System.properties.getProperty("karate.options")
//    systemProperty "karate.env", System.properties.getProperty("karate.env")
//    outputs.upToDateWhen { false }
//}
//
//tasks.named('integrationTest') {
//    useJUnitPlatform {
//        includeTags 'KarateTest'
//    }
//    failFast = true
//    testLogging {
//        events 'skipped', 'passed', 'failed'
//    }
//    finalizedBy jacocoTestReport
//}
//
//sourceSets {
//
//    test {
//        resources {
//            srcDir file('src/test/java')
//            exclude '**/*.java'
//        }
//    }
//}

//def karateTest = tasks.register('karateTest', Test) {
//    description = 'Runs karate integration tests.'
//    group = 'verification'
//    useJUnitPlatform {
//        excludeTags 'KarateTest'
//    }
//    shouldRunAfter(tasks.named('test'))
//}

